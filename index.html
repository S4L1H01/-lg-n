<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN: KABƒ∞LE v4.0 - Master Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --mor: #a855f7; --kirmizi: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #020617; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        /* G√ñRSEL EFEKTLER */
        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: radial-gradient(circle, #1e1b4b, #020617); }
        
        /* KARAKTER TASARIMI (YENƒ∞) */
        .char-body { width: 45px; height: 55px; position: relative; transition: 0.3s; }
        .char-cape { width: 100%; height: 80%; background: #475569; border-radius: 10px 10px 5px 5px; position: absolute; bottom: 0; border: 2px solid #000; }
        .char-head { width: 24px; height: 24px; background: #ffdbac; border-radius: 50%; border: 2px solid #000; position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
        .char-eyes { width: 100%; position: absolute; top: 10px; display: flex; justify-content: space-around; padding: 0 4px; }
        .eye { width: 4px; height: 4px; background: black; border-radius: 50%; }

        /* ATE≈û VE ATMOSFER */
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; z-index: 10; filter: drop-shadow(0 0 40px orange); animation: fire-flicker 0.15s infinite alternate; }
        @keyframes fire-flicker { 0% { transform: translate(-50%, -50%) scale(1) rotate(-2deg); } 100% { transform: translate(-50%, -50%) scale(1.1) rotate(2deg); opacity: 0.8; } }
        
        .sis { position: absolute; width: 200%; height: 200%; background: url('https://www.transparenttextures.com/patterns/fog.png'); opacity: 0; pointer-events: none; transition: 3s; z-index: 20; }
        .gece-modu .sis { opacity: 0.15; animation: fog-move 60s infinite linear; }
        @keyframes fog-move { from { transform: translate(-25%, -25%); } to { transform: translate(0, 0); } }

        /* MODAL VE UI */
        .ui-card { background: rgba(15, 23, 42, 0.9); border: 3px solid var(--altin); border-radius: 20px; padding: 20px; box-shadow: 0 0 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .btn { padding: 15px 30px; border-radius: 12px; border: none; font-weight: 900; font-family: 'Cinzel'; cursor: pointer; transition: 0.2s; background: var(--yesil); color: black; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }

        #rol-tabelasi { position: fixed; top: 20px; right: 20px; background: linear-gradient(45deg, var(--altin), #d97706); color: #000; padding: 15px 25px; border-radius: 15px; font-weight: 900; z-index: 1001; border: 3px solid #000; font-family: 'Cinzel'; box-shadow: 6px 6px 0 #000; }
        #info-bar { position: fixed; top: 25px; width: 100%; text-align: center; font-size: 32px; font-weight: 900; color: #fff; z-index: 100; text-shadow: 4px 4px #000; font-family: 'Cinzel'; }

        /* OYUNCU CADIRLARI */
        .cadir-container { position: absolute; width: 100px; transition: 0.5s; cursor: pointer; }
        .cadir-icon { font-size: 60px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        .oyuncu-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 13px; font-weight: 900; white-space: nowrap; color: white; text-shadow: 2px 2px #000; }

    </style>
</head>
<body>

    <div class="sis"></div>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <h1 style="color:var(--altin); font-size: 80px; font-family:'Cinzel'; text-shadow: 6px 6px var(--mor); margin:0;">√úLG√úN</h1>
        <p style="color: white; font-weight: bold; margin-bottom: 30px; opacity: 0.7;">KABƒ∞LE MECLƒ∞Sƒ∞NE HO≈û GELDƒ∞N</p>
        <div class="ui-card" style="width: 350px; text-align: center;">
            <input type="text" id="my-name" placeholder="KABƒ∞LE ADINIZ" style="background:transparent; border:none; border-bottom:3px solid var(--mor); color:white; font-size:20px; text-align:center; width:100%; margin-bottom:20px; outline:none;">
            <button class="btn" style="width:100%; margin-bottom:10px; background:var(--mavi); color:white;" onclick="hostLobby()">LOBƒ∞ KUR</button>
            <button class="btn" style="width:100%; background:var(--kirmizi); color:white;" onclick="joinLobby()">KODLA KATIL</button>
        </div>
    </div>

    <div id="lobi-ekrani" class="ekran" style="padding: 40px; background: #020617;">
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; height: 80%;">
            <div id="player-area" style="border:4px solid #1e293b; border-radius: 20px; position: relative; background: #0f172a;" onclick="sendMove(event)"></div>
            <div class="ui-card">
                <h2 style="color:var(--altin); font-family:'Cinzel';">AYARLAR</h2>
                <label>‚òÄÔ∏è G√úND√úZ: <span id="gv">60</span>s</label>
                <input type="range" id="gs" min="15" max="180" value="60" oninput="gv.innerText=this.value" style="width:100%; margin-bottom:20px;">
                <label>üåô GECE: <span id="nv">30</span>s</label>
                <input type="range" id="ns" min="15" max="120" value="30" oninput="nv.innerText=this.value" style="width:100%; margin-bottom:20px;">
                <hr border="1" color="#334155">
                <p id="status">Bekleniyor...</p>
                <button class="btn" style="width:100%" onclick="startGame()">BA≈ûLAT</button>
            </div>
        </div>
        <div id="my-code" onclick="copyCode()" style="margin-top:20px; font-family:'Cinzel'; color:var(--mavi); cursor:pointer; text-align:center; font-size:24px;">KOD: ---</div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="ay">üåô</div>
        <div id="rol-tabelasi">ROL: Y√úKLENƒ∞YOR...</div>
        <div id="info-bar">‚òÄÔ∏è G√úND√úZ</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
    </div>

    <script>
        let peer; let connections = []; let players = []; let isHost = false; let tur = 1;
        const ROLLER = ["≈ûifacƒ±", "Katil", "Bek√ßi", "G√∂zc√º", "Bilge", "Meczup", "Avcƒ±", "ƒ∞zci", "Diren√ßli", "ƒ∞spiyoncu", "G√∂lge", "K√∂t√º Polis", "Kaos", "Gardiyan"];

        function hostLobby() {
            const nick = document.getElementById('my-name').value;
            if(!nick) return alert("Adƒ±nƒ± yaz!");
            isHost = true;
            peer = new Peer(Math.random().toString(36).substring(2, 7).toUpperCase());
            peer.on('open', id => {
                document.getElementById('my-code').innerText = "KOD: " + id;
                players.push({id, name: nick, x: 50, y: 50});
                updateLobby();
            });
            peer.on('connection', c => {
                c.on('open', () => {
                    connections.push(c);
                    c.on('data', data => handleData(data, c));
                });
            });
            showScreen('lobi-ekrani');
        }

        function joinLobby() {
            const nick = document.getElementById('my-name').value;
            const code = prompt("Lobi Kodu:");
            if(!nick || !code) return;
            peer = new Peer();
            peer.on('open', () => {
                const c = peer.connect(code.toUpperCase());
                c.on('open', () => {
                    connections.push(c);
                    c.send({type: 'join', name: nick});
                    showScreen('lobi-ekrani');
                });
                c.on('data', handleData);
            });
        }

        function handleData(data, c) {
            if(data.type === 'join' && isHost) {
                players.push({id: c.peer, name: data.name, x: 50, y: 50});
                broadcast({type: 'sync', players});
            }
            if(data.type === 'sync') { players = data.players; updateLobby(); }
            if(data.type === 'move') { updateRemotePos(data.id, data.x, data.y); }
            if(data.type === 'start') { runGame(data.roles, data.gS, data.nS); }
        }

        function updateLobby() {
            const area = document.getElementById('player-area');
            area.innerHTML = "";
            players.forEach(p => {
                area.innerHTML += `
                    <div id="p-${p.id}" class="char-body" style="position:absolute; left:${p.x}px; top:${p.y}px">
                        <div class="char-head"><div class="char-eyes"><div class="eye"></div><div class="eye"></div></div></div>
                        <div class="char-cape"></div>
                        <div class="oyuncu-label">${p.name}</div>
                    </div>`;
            });
            document.getElementById('status').innerText = players.length + " Ki≈üi Hazƒ±r";
        }

        function sendMove(e) {
            const rect = document.getElementById('player-area').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 22;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 22;
            updateRemotePos(peer.id, x, y);
            const msg = {type: 'move', id: peer.id, x, y};
            if(isHost) broadcast(msg); else connections[0].send(msg);
        }

        function updateRemotePos(id, x, y) {
            const p = document.getElementById(`p-${id}`);
            if(p) { p.style.left = x + "px"; p.style.top = y + "px"; }
        }

        function broadcast(data) { connections.forEach(c => c.send(data)); }
        function showScreen(id) { 
            document.querySelectorAll('.ekran').forEach(e => e.style.display = 'none');
            document.getElementById(id).style.display = (id === 'lobi-ekrani' ? 'block' : 'flex');
        }

        function startGame() {
            if(!isHost) return;
            const roles = [...ROLLER].sort(() => Math.random() - 0.5);
            const gS = document.getElementById('gs').value;
            const nS = document.getElementById('ns').value;
            broadcast({type: 'start', roles, gS, nS});
            runGame(roles, gS, nS);
        }

        function runGame(roles, gS, nS) {
            showScreen('oyun-ekrani');
            const myIndex = players.findIndex(p => p.id === peer.id);
            document.getElementById('rol-tabelasi').innerText = "ROL: " + roles[myIndex];
            
            const oba = document.getElementById('oba');
            const center = {x: window.innerWidth/2, y: window.innerHeight/2};
            const r = Math.min(window.innerWidth, window.innerHeight) * 0.35;

            oba.innerHTML = "";
            for(let i=0; i<12; i++) {
                const angle = (i * 2 * Math.PI) / 12;
                const x = center.x + r * Math.cos(angle) - 50;
                const y = center.y + r * Math.sin(angle) - 50;
                const name = players[i] ? players[i].name : "Yabancƒ± " + (i+1);
                const color = players[i] ? "var(--mor)" : "#475569";

                oba.innerHTML += `
                    <div class="cadir-container" style="left:${x}px; top:${y}px" onclick="interact(${i})">
                        <div class="cadir-icon">‚õ∫</div>
                        <div class="char-body" id="oba-p-${i}" style="margin: -20px auto 0; transform: scale(0.8);">
                            <div class="char-head"><div class="char-eyes"><div class="eye"></div><div class="eye"></div></div></div>
                            <div class="char-cape" style="background:${color}"></div>
                            <div class="oyuncu-label">${name}</div>
                        </div>
                    </div>`;
            }
            startTimer(parseInt(gS), parseInt(nS));
        }

        function interact(id) {
            if(!document.getElementById('oyun-ekrani').classList.contains('gece-modu')) return;
            const p = document.getElementById('oba-p-0');
            p.style.transition = "3.3s linear";
            p.style.transform = "scale(1.2) translateY(-20px)";
            setTimeout(() => p.style.transform = "scale(0.8) translateY(0)", 3500);
        }

        function startTimer(gs, ns) {
            let s = gs; let mode = "G√úND√úZ";
            setInterval(() => {
                s--;
                if(s <= 0) {
                    mode = (mode === "G√úND√úZ" ? "GECE" : "G√úND√úZ");
                    s = (mode === "G√úND√úZ" ? gs : ns);
                    document.getElementById('oyun-ekrani').classList.toggle('gece-modu');
                }
                document.getElementById('info-bar').innerText = (mode === "G√úND√úZ" ? "‚òÄÔ∏è " : "üåô ") + mode + ": " + s + "s";
            }, 1000);
        }

        function copyCode() {
            const c = document.getElementById('my-code').innerText.split(' ')[1];
            navigator.clipboard.writeText(c);
            alert("Kod kopyalandƒ±!");
        }
    </script>
</body>
</html>
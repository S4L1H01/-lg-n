<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN: KABƒ∞LE MECLƒ∞Sƒ∞</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mor: #8b5cf6; --kirmizi: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #020617; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        /* Gƒ∞Rƒ∞≈û VE LOBƒ∞ (Daha Profesyonel G√∂r√ºn√ºm) */
        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; transition: 0.5s ease-in-out; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: linear-gradient(to bottom, #0f172a, #020617); }
        .menu-box { width: 90%; max-width: 450px; padding: 30px; border: 4px solid; text-align: center; border-radius: 24px; font-weight: 900; font-size: 24px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .box-isim { border-color: var(--mor); cursor: default; }
        .box-katil { border-color: var(--kirmizi); background: rgba(239, 68, 68, 0.1); }
        .box-kur { border-color: var(--mavi); background: rgba(59, 130, 246, 0.1); }
        input { background: transparent; border: none; border-bottom: 4px solid var(--mor); color: white; text-align: center; font-size: 24px; width: 100%; outline: none; }

        /* LOBƒ∞ TASARIMI */
        #lobi-ekrani { grid-template-columns: 1.2fr 1fr; grid-template-rows: 1.5fr 1fr 0.6fr; gap: 15px; padding: 20px; background: #0f172a; }
        .bolge { border: 2px solid #334155; border-radius: 20px; position: relative; padding: 20px; background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); }
        #player-area { height: 100%; width: 100%; position: relative; background: radial-gradient(circle, #334155 1px, transparent 1px); background-size: 20px 20px; }
        .p-body { position: absolute; width: 50px; height: 50px; background: #fff; border-radius: 50%; border: 4px solid #000; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .p-label { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #000; padding: 3px 10px; border-radius: 8px; font-size: 13px; white-space: nowrap; border: 1.5px solid #fff; }

        /* OYUN EKRANI (Oba) */
        #oyun-ekrani { background: #064e3b; transition: background 2s ease; position: relative; }
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; z-index: 10; filter: drop-shadow(0 0 40px orange); animation: flicker 0.1s infinite alternate; }
        @keyframes flicker { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.05); } }
        
        .cadir { position: absolute; width: 110px; text-align: center; z-index: 5; transition: 0.3s; }
        .cadir:hover { transform: scale(1.1); }
        .oyuncu-govde { width: 50px; height: 50px; background: #64748b; border-radius: 50%; margin: 0 auto; position: relative; border: 3px solid #000; transition: all 3.3s linear; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* CAN BARI */
        .hp-bar { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 40px; height: 6px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid #fff; }
        .hp-fill { width: 100%; height: 100%; background: var(--yesil); transition: 0.5s; }

        /* GECE MODU TASARIMI */
        .gece-modu { background: #020617 !important; }
        #yildizlar { position: absolute; width: 100%; height: 100%; background: transparent; pointer-events: none; opacity: 0; transition: 2s; }
        .gece-modu #yildizlar { opacity: 1; background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 10px); background-size: 100px 100px; }
        #ay { position: absolute; top: 40px; right: 40px; font-size: 60px; filter: drop-shadow(0 0 20px #fff); display: none; }
        .gece-modu #ay { display: block; animation: float 5s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* PANEL VE TABELALAR */
        #rol-tabelasi { position: fixed; top: 20px; right: 20px; background: var(--altin); color: #000; padding: 15px 25px; border-radius: 15px; font-weight: 900; font-size: 20px; border: 4px solid #000; z-index: 1001; box-shadow: 6px 6px 0px rgba(0,0,0,0.8); }
        #info-bar { position: fixed; top: 20px; width: 100%; text-align: center; font-size: 32px; font-weight: 900; color: #fff; text-shadow: 3px 3px 0 #000; z-index: 100; }
        
        /* NOT DEFTERƒ∞ (Daha ≈ûƒ±k) */
        #not-defteri { position: fixed; bottom: 20px; right: 20px; width: 250px; height: 280px; background: #fef3c7; color: #451a03; border-radius: 15px; padding: 15px; box-shadow: 8px 8px 0px rgba(0,0,0,0.5); z-index: 1000; border: 3px solid #d97706; transform: rotate(1deg); }
        #not-text { width: 100%; height: 85%; background: transparent; border: none; resize: none; outline: none; font-family: 'Courier New', monospace; font-size: 14px; font-weight: 700; border-top: 1px dashed #d97706; padding-top: 5px; }

        /* OYLAMA G√ñSTERGESƒ∞ */
        .vote-badge { position: absolute; top: -55px; left: 50%; transform: translateX(-50%); background: var(--kirmizi); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; border: 2px solid white; display: none; }

        .btn { padding: 15px 35px; border-radius: 15px; border: none; font-weight: 900; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .btn:active { transform: scale(0.9); }
    </style>
</head>
<body>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <h1 style="font-size: 60px; color: var(--altin); text-shadow: 5px 5px 0px var(--mor);">√úLG√úN</h1>
        <div class="menu-box box-isim"><input type="text" id="my-name" placeholder="KABƒ∞LE ADINIZ"></div>
        <div class="menu-box box-katil" onclick="joinLobby()">KOD ƒ∞LE KATIL</div>
        <div class="menu-box box-kur" onclick="hostLobby()">LOBƒ∞ KUR</div>
    </div>

    <div id="lobi-ekrani" class="ekran">
        <div id="gri-bolge" class="bolge" onclick="sendMove(event)">
            <div id="player-area"></div>
            <p style="color:var(--altin); font-weight:bold;">üìç LOBƒ∞: Karakterini burada test et.</p>
        </div>
        <div id="yesil-bolge" class="bolge">
            <h2 style="color:var(--yesil); margin:0;">üìú ROLLER</h2>
            <div id="roles-info" style="font-size: 13px; color: #94a3b8; margin-bottom:10px;">≈ûifacƒ± can verir, Katil can alƒ±r, Bek√ßi korur.</div>
            <div id="roles-list"></div>
        </div>
        <div id="mor-bolge" class="bolge">
            <h3>üë• Kƒ∞≈ûƒ∞ SAYISI</h3>
            <input type="number" id="player-count" value="12" min="2" max="12" style="width: 120px; font-size: 35px; color: var(--altin);">
        </div>
        <div id="lacivert-bolge" class="bolge">
            ‚òÄÔ∏è: <span id="gv">60</span>s | üåô: <span id="nv">30</span>s
            <input type="range" id="gs" min="10" max="180" value="60" oninput="gv.innerText=this.value" style="width:100%">
            <input type="range" id="ns" min="10" max="180" value="30" oninput="nv.innerText=this.value" style="width:100%">
        </div>
        <div id="acik-mavi-bolge" class="bolge">
            <h2 id="my-code" style="color:var(--mavi); letter-spacing: 2px;">KOD: ------</h2>
            <button class="btn" onclick="startGame()" style="background:var(--yesil); color: #000;">MECLƒ∞Sƒ∞ TOPLA</button>
        </div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="yildizlar"></div>
        <div id="ay">üåô</div>
        <div id="rol-tabelasi">ROL: ≈ûifacƒ±</div>
        <div id="info-bar">‚òÄÔ∏è G√úND√úZ</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
        
        <div id="not-defteri">
            <b>üìî KABƒ∞LE G√úNL√úƒû√ú</b>
            <textarea id="not-text" placeholder="√ñrn: 3. Oyuncudan ≈ü√ºpheliyim..."></textarea>
        </div>
    </div>

    <script>
        let peer; let conn; let myNick = ""; let tur = 1;
        let myRol = ""; let isAlive = true; let myHP = 100;
        const rollar = ["≈ûifacƒ±", "Katil", "Bek√ßi", "G√∂zc√º", "Bilge", "Diren√ßli", "Avcƒ±", "Katil", "Meczup", "≈ûifacƒ±", "ƒ∞zci", "Bek√ßi"];

        function hostLobby() {
            myNick = document.getElementById('my-name').value;
            if(!myNick) return alert("Adƒ±nƒ± yaz kabile reisi!");
            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', id => {
                document.getElementById('my-code').innerText = "KOD: " + id;
                initLobby();
            });
            peer.on('connection', c => { conn = c; setupConn(); });
        }

        function joinLobby() {
            myNick = document.getElementById('my-name').value;
            const code = prompt("Katƒ±lacaƒüƒ±n Kabilenin Kodu:");
            if(!code || !myNick) return;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                setupConn();
                initLobby();
            });
        }

        function setupConn() {
            conn.on('data', data => { if(data.type === 'start') realStart(data.count); });
        }

        function initLobby() {
            document.getElementById('ana-menu').style.display = 'none';
            document.getElementById('lobi-ekrani').style.display = 'grid';
            document.getElementById('player-area').innerHTML = `<div id="p-me" class="p-body" style="left:50px; top:50px;"><span class="p-label">${myNick}</span></div>`;
            const list = document.getElementById('roles-list');
            rollar.forEach(r => { list.innerHTML += `<div style="color:var(--yesil); font-weight:bold; font-size:18px;">‚óà ${r}</div>`; });
        }

        function sendMove(e) {
            const rect = document.getElementById('gri-bolge').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 25;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 25;
            document.getElementById('p-me').style.left = x + "px";
            document.getElementById('p-me').style.top = y + "px";
        }

        function startGame() {
            const count = document.getElementById('player-count').value;
            if(conn) conn.send({type: 'start', count: count});
            realStart(count);
        }

        function realStart(count) {
            myRol = rollar[Math.floor(Math.random() * count)];
            document.getElementById('rol-tabelasi').innerText = "ROL: " + myRol;
            document.getElementById('lobi-ekrani').style.display = 'none';
            document.getElementById('oyun-ekrani').style.display = 'block';
            
            const oba = document.getElementById('oba');
            const mX = window.innerWidth / 2; const mY = window.innerHeight / 2;
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.35;

            oba.innerHTML = "";
            for(let i=0; i<count; i++) {
                const aci = (i * 2 * Math.PI) / count;
                const x = mX + radius * Math.cos(aci) - 55;
                const y = mY + radius * Math.sin(aci) - 55;
                
                oba.innerHTML += `
                    <div class="cadir" style="left:${x}px; top:${y}px" onclick="cadirEtkilesim(${i})">
                        <div class="vote-badge" id="v-${i}">0 OY</div>
                        <div style="font-size:55px">‚õ∫</div>
                        <div class="oyuncu-govde" id="oba-p-${i}">
                            <div class="hp-bar"><div class="hp-fill" id="hp-${i}"></div></div>
                            <div style="position:absolute; bottom:-30px; left:50%; transform:translateX(-50%); font-size:14px; font-weight:900; white-space:nowrap; color:#fff;">${i===0 ? myNick : 'Oyuncu '+(i+1)}</div>
                        </div>
                    </div>`;
            }
            gameLoop();
        }

        function cadirEtkilesim(id) {
            if(!isAlive) return;
            const oyunEkrani = document.getElementById('oyun-ekrani');
            
            if(oyunEkrani.classList.contains('gece-modu')) {
                // GECE: ROL√úN√ú KULLAN
                rolAnimasyon(id);
            } else {
                // G√úND√úZ: OY VER
                oyVer(id);
            }
        }

        function oyVer(id) {
            const badge = document.getElementById(`v-${id}`);
            badge.style.display = "block";
            let currentVotes = parseInt(badge.innerText);
            badge.innerText = (currentVotes + 1) + " OY";
            document.getElementById('not-text').value += `‚úì G√ºnd√ºz: ${id+1}. oyuncuya oy verdin.\n`;
        }

        function rolAnimasyon(id) {
            const p = document.getElementById('oba-p-0');
            const hedef = document.querySelectorAll('.cadir')[id].getBoundingClientRect();
            const suan = p.getBoundingClientRect();

            p.style.position = "fixed";
            p.style.left = suan.left + "px"; p.style.top = suan.top + "px";
            p.style.zIndex = "100";
            
            setTimeout(() => {
                p.style.left = (hedef.left + 25) + "px";
                p.style.top = (hedef.top + 25) + "px";
                // Rol Yetenek Efekti
                if(myRol === "≈ûifacƒ±") p.style.boxShadow = "0 0 30px var(--yesil)";
                if(myRol === "Katil") p.style.boxShadow = "0 0 30px var(--kirmizi)";
                if(myRol === "Bek√ßi") p.style.boxShadow = "0 0 30px var(--mavi)";
            }, 50);

            document.getElementById('not-text').value += `‚ö° ${tur}. Gece: ${myRol} g√ºc√ºn√º ${id+1}. evde kullandƒ±n.\n`;

            setTimeout(() => {
                p.style.position = "relative"; p.style.left = "0"; p.style.top = "0";
                p.style.boxShadow = "none";
            }, 3350);
        }

        function gameLoop() {
            let sn = parseInt(document.getElementById('gs').value);
            let mod = "G√úND√úZ";
            setInterval(() => {
                sn--;
                if(sn <= 0) {
                    if(mod === "GECE") { 
                        tur++;
                        document.querySelectorAll('.vote-badge').forEach(b => b.style.display = "none");
                    }
                    mod = (mod === "G√úND√úZ") ? "GECE" : "G√úND√úZ";
                    sn = (mod === "G√úND√úZ") ? parseInt(document.getElementById('gs').value) : parseInt(document.getElementById('ns').value);
                    document.getElementById('oyun-ekrani').classList.toggle('gece-modu');
                }
                const ikon = (mod === "G√úND√úZ") ? "‚òÄÔ∏è" : "üåô";
                document.getElementById('info-bar').innerText = ikon + " " + mod + ": " + sn + "s";
                
                // Can Barƒ± Sim√ºlasyonu (Katil saldƒ±rƒ±rsa azalƒ±r)
                if(Math.random() < 0.01 && isAlive) {
                    myHP -= 5;
                    document.getElementById('hp-0').style.width = myHP + "%";
                    if(myHP <= 0) { 
                        isAlive = false; 
                        document.getElementById('oba-p-0').style.opacity = "0.4";
                        alert("KABƒ∞LE MECLƒ∞Sƒ∞NDEN ELENDƒ∞N (√ñLD√úN)!");
                    }
                }
            }, 1000);
        }
    </script>
</body>
</html>
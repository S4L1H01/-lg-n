<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN: KABƒ∞LE v4.5</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --mor: #a855f7; --kirmizi: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #020617; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: radial-gradient(circle, #1e1b4b, #020617); }
        
        /* KARAKTER TASARIMI */
        .char-body { width: 45px; height: 55px; position: relative; transition: 0.2s linear; }
        .char-cape { width: 100%; height: 80%; background: #475569; border-radius: 10px 10px 5px 5px; position: absolute; bottom: 0; border: 2px solid #000; }
        .char-head { width: 24px; height: 24px; background: #ffdbac; border-radius: 50%; border: 2px solid #000; position: absolute; top: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
        .char-eyes { width: 100%; position: absolute; top: 10px; display: flex; justify-content: space-around; padding: 0 4px; }
        .eye { width: 4px; height: 4px; background: black; border-radius: 50%; }

        /* LOBƒ∞ VE ROL Lƒ∞STESƒ∞ */
        #lobi-ekrani { grid-template-columns: 1.2fr 1fr; grid-template-rows: 1fr 100px; gap: 15px; padding: 20px; background: #0f172a; }
        .bolge { border: 2px solid #334155; border-radius: 20px; position: relative; padding: 15px; background: rgba(30, 41, 59, 0.4); overflow: hidden; }
        #roles-list { height: 100%; overflow-y: auto; padding-right: 5px; }
        .role-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); margin-bottom: 5px; padding: 8px; border-radius: 10px; border-left: 4px solid var(--yesil); }
        .info-btn { background: var(--mavi); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; font-weight: bold; }

        /* OYUN */
        #oyun-ekrani { background: #14532d; transition: background 2s; }
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; z-index: 10; filter: drop-shadow(0 0 40px orange); }
        .gece-modu { background: #080c29 !important; }
        
        #rol-tabelasi { position: fixed; top: 20px; right: 20px; background: var(--altin); color: #000; padding: 15px 25px; border-radius: 15px; font-weight: 900; z-index: 1001; border: 3px solid #000; font-family: 'Cinzel'; }
        #info-bar { position: fixed; top: 25px; width: 100%; text-align: center; font-size: 30px; font-weight: 900; z-index: 100; font-family: 'Cinzel'; text-shadow: 2px 2px #000; }

        .btn { padding: 15px 30px; border-radius: 12px; border: none; font-weight: 900; font-family: 'Cinzel'; cursor: pointer; background: var(--yesil); color: black; }
    </style>
</head>
<body>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <h1 style="color:var(--altin); font-size: 60px; font-family:'Cinzel';">√úLG√úN</h1>
        <input type="text" id="my-name" placeholder="ADINIZ" style="background:transparent; border:none; border-bottom:3px solid var(--mor); color:white; font-size:24px; text-align:center; margin-bottom:20px; outline:none;">
        <button class="btn" onclick="hostLobby()" style="margin-bottom:10px;">LOBƒ∞ KUR</button>
        <button class="btn" style="background:var(--kirmizi)" onclick="joinLobby()">KODLA KATIL</button>
    </div>

    <div id="lobi-ekrani" class="ekran">
        <div class="bolge" id="player-area" onclick="sendMove(event)"></div>
        <div class="bolge">
            <h3 style="color:var(--yesil); font-family:'Cinzel'; margin-top:0;">üìú ROLLER</h3>
            <div id="roles-list"></div>
        </div>
        <div class="bolge" style="grid-column: span 2; display: flex; justify-content: space-between; align-items: center;">
            <div id="my-code" onclick="copyCode()" style="cursor:pointer; font-family:'Cinzel'; color:var(--mavi)">KOD: ---</div>
            <div id="lobby-count" style="font-weight:bold;">1 Oyuncu Hazƒ±r</div>
            <button class="btn" onclick="startGame()">MECLƒ∞Sƒ∞ TOPLA</button>
        </div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="rol-tabelasi">ROL√úN: ...</div>
        <div id="info-bar">‚òÄÔ∏è G√úND√úZ</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
    </div>

    <script>
        let peer; let connections = []; let players = []; let isHost = false;
        const ROLLER = [
            {n: "≈ûifacƒ±", d: "Gece birini iyile≈ütirir."}, {n: "Katil", d: "Gece birini √∂ld√ºr√ºr."},
            {n: "Bek√ßi", d: "Birini korumaya alƒ±r."}, {n: "G√∂zc√º", d: "Kimin kime gittiƒüini g√∂r√ºr."},
            {n: "Bilge", d: "Birinin rol√ºn√º √∂ƒürenir."}, {n: "Meczup", d: "Kazanmak i√ßin asƒ±lmasƒ± gerekir."},
            {n: "Avcƒ±", d: "√ñl√ºrken birini de g√∂t√ºr√ºr."}, {n: "ƒ∞zci", d: "Geceleri iz s√ºrer."},
            {n: "Diren√ßli", d: "ƒ∞lk saldƒ±rƒ±da √∂lmez."}, {n: "ƒ∞spiyoncu", d: "Fƒ±sƒ±lda≈ümalarƒ± duyar."},
            {n: "G√∂lge", d: "Karakterini gizler."}, {n: "K√∂t√º Polis", d: "Sorgulama yapar."},
            {n: "Kaos", d: "Her gece farklƒ± bir g√º√ß."}, {n: "Gardiyan", d: "Birini hapse atar."}
        ];

        function hostLobby() {
            const nick = document.getElementById('my-name').value;
            if(!nick) return alert("ƒ∞sim yaz!");
            isHost = true;
            peer = new Peer(Math.random().toString(36).substring(2, 7).toUpperCase());
            peer.on('open', id => {
                document.getElementById('my-code').innerText = "KOD: " + id + " (Kopyala)";
                players.push({id, name: nick, x: 50, y: 50});
                updateLobby();
            });
            peer.on('connection', c => {
                c.on('open', () => {
                    connections.push(c);
                    c.on('data', data => handleData(data, c));
                });
            });
            initLobbyUI();
        }

        function joinLobby() {
            const nick = document.getElementById('my-name').value;
            const code = prompt("Kod:");
            if(!nick || !code) return;
            peer = new Peer();
            peer.on('open', () => {
                const c = peer.connect(code.toUpperCase());
                c.on('open', () => {
                    connections.push(c);
                    c.send({type: 'join', name: nick});
                    initLobbyUI();
                    document.getElementById('my-code').innerText = "KOD: " + code;
                });
                c.on('data', handleData);
            });
        }

        function handleData(data, c) {
            if(data.type === 'join' && isHost) {
                players.push({id: c.peer, name: data.name, x: 50, y: 50});
                broadcast({type: 'sync', players});
                updateLobby();
            }
            if(data.type === 'sync') { players = data.players; updateLobby(); }
            if(data.type === 'move') { updateRemotePos(data.id, data.x, data.y); }
            if(data.type === 'start') { runGame(data.roles); }
        }

        function initLobbyUI() {
            document.getElementById('ana-menu').style.display = 'none';
            document.getElementById('lobi-ekrani').style.display = 'grid';
            const list = document.getElementById('roles-list');
            ROLLER.forEach(r => {
                list.innerHTML += `<div class="role-item"><span>${r.n}</span><div class="info-btn" onclick="alert('${r.d}')">?</div></div>`;
            });
        }

        function sendMove(e) {
            const rect = document.getElementById('player-area').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 22;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 22;
            updateRemotePos(peer.id, x, y);
            const msg = {type: 'move', id: peer.id, x, y};
            if(isHost) broadcast(msg); else connections[0].send(msg);
        }

        function updateRemotePos(id, x, y) {
            const p = document.getElementById(`p-${id}`);
            if(p) { p.style.left = x + "px"; p.style.top = y + "px"; }
        }

        function updateLobby() {
            const area = document.getElementById('player-area');
            area.innerHTML = "";
            players.forEach(p => {
                area.innerHTML += `<div id="p-${p.id}" class="char-body" style="position:absolute; left:${p.x}px; top:${p.y}px">
                    <div class="char-head"><div class="char-eyes"><div class="eye"></div><div class="eye"></div></div></div>
                    <div class="char-cape"></div><div style="font-size:10px; text-align:center;">${p.name}</div></div>`;
            });
            document.getElementById('lobby-count').innerText = players.length + " Oyuncu Hazƒ±r";
        }

        function broadcast(data) { connections.forEach(c => c.send(data)); }

        function startGame() {
            if(!isHost) return;
            const roles = ROLLER.map(r => r.n).sort(() => Math.random() - 0.5);
            broadcast({type: 'start', roles});
            runGame(roles);
        }

        function runGame(roles) {
            document.getElementById('lobi-ekrani').style.display = 'none';
            document.getElementById('oyun-ekrani').style.display = 'block';
            const myIndex = players.findIndex(p => p.id === peer.id);
            document.getElementById('rol-tabelasi').innerText = "ROL√úN: " + roles[myIndex];

            const count = players.length < 2 ? 4 : players.length; // Tek ba≈üƒ±naysa 4 ki≈üi (botlarla) ba≈ülar
            const oba = document.getElementById('oba');
            const center = {x: window.innerWidth/2, y: window.innerHeight/2};
            const r = Math.min(window.innerWidth, window.innerHeight) * 0.35;

            oba.innerHTML = "";
            for(let i=0; i<count; i++) {
                const angle = (i * 2 * Math.PI) / count;
                const x = center.x + r * Math.cos(angle) - 45;
                const y = center.y + r * Math.sin(angle) - 45;
                const name = players[i] ? players[i].name : "Bot " + (i+1);
                oba.innerHTML += `<div style="position:absolute; left:${x}px; top:${y}px; text-align:center;">
                    <div style="font-size:50px">‚õ∫</div><div style="font-weight:900;">${name}</div></div>`;
            }
        }

        function copyCode() {
            const c = document.getElementById('my-code').innerText.split(' ')[1];
            navigator.clipboard.writeText(c);
            alert("Kod kopyalandƒ±!");
        }
    </script>
</body>
</html>
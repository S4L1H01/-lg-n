<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN ONLINE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mor: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #0f172a; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        /* 1. Gƒ∞Rƒ∞≈û EKRANI */
        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); }
        .menu-box { width: 90%; max-width: 400px; padding: 30px; border: 6px solid; text-align: center; border-radius: 20px; font-weight: 900; font-size: 24px; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .box-isim { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        .box-katil { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); cursor: pointer; }
        .box-kur { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); cursor: pointer; }
        input { background: transparent; border: none; border-bottom: 4px solid #8b5cf6; color: white; text-align: center; font-size: 24px; width: 100%; outline: none; }

        /* 2. LOBƒ∞ EKRANI */
        #lobi-ekrani { grid-template-columns: 1fr 1fr; grid-template-rows: 1.5fr 1fr 0.6fr; gap: 10px; padding: 15px; background: #1e293b; }
        .bolge { border: 3px solid #475569; border-radius: 15px; position: relative; overflow: hidden; padding: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); }
        #gri-bolge { grid-column: span 1; background: #334155; }
        #yesil-bolge { grid-row: span 2; background: #064e3b; border-color: var(--yesil); overflow-y: auto; }
        #mor-bolge { background: #4c1d95; border-color: #a78bfa; }
        #lacivert-bolge { background: #1e3a8a; border-color: var(--mavi); }
        #acik-mavi-bolge { grid-column: span 2; background: #134e4a; display: flex; justify-content: space-around; align-items: center; border-color: #2dd4bf; }

        /* KARAKTERLER */
        .p-body { position: absolute; width: 45px; height: 45px; background: #f8fafc; border-radius: 50%; border: 3px solid #000; transition: 0.4s ease; display: flex; align-items: center; justify-content: center; }
        .p-label { position: absolute; top: -35px; background: #000; color: #fff; padding: 4px 10px; border-radius: 8px; font-size: 14px; border: 1.5px solid #fff; white-space: nowrap; font-weight: bold; }

        /* 3. OBA (OYUN) */
        #oyun-ekrani { background: #14532d; }
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; z-index: 10; filter: drop-shadow(0 0 30px orange); }
        .cadir { position: absolute; width: 100px; text-align: center; z-index: 5; cursor: pointer; }
        .oyuncu-govde { width: 45px; height: 45px; background: #94a3b8; border-radius: 50%; margin: 0 auto; position: relative; border: 3px solid #000; transition: all 3.3s linear; }
        .nick-tag { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: white; color: black; font-size: 14px; padding: 3px 8px; border-radius: 8px; font-weight: bold; border: 2px solid #000; }

        /* GECE MODU */
        .gece { filter: brightness(0.2) contrast(1.3); }
        .gece .nick-tag, .gece .p-label { display: none !important; }

        #info-bar { position: fixed; top: 25px; width: 100%; text-align: center; font-size: 32px; font-weight: 900; color: var(--altin); z-index: 100; text-shadow: 3px 3px 0 #000; }
        .rol-text { font-size: 22px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; color: var(--yesil); font-weight: bold; }
        button { padding: 15px 35px; border-radius: 12px; border: none; font-weight: 900; font-size: 20px; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <div class="menu-box box-isim"><input type="text" id="my-name" placeholder="ADINI YAZ"></div>
        <div class="menu-box box-katil" onclick="joinLobby()">KOD ƒ∞LE KATIL</div>
        <div class="menu-box box-kur" onclick="hostLobby()">LOBƒ∞ KUR</div>
    </div>

    <div id="lobi-ekrani" class="ekran">
        <div id="gri-bolge" class="bolge" onclick="sendMove(event)">
            <div id="player-area"></div>
        </div>
        <div id="yesil-bolge" class="bolge">
            <h2 style="color:var(--yesil); margin:0 0 15px 0; font-size: 30px;">ROLLER</h2>
            <div id="roles"></div>
        </div>
        <div id="mor-bolge" class="bolge">
            <h3>SEMBOLLER (4 HARF)</h3>
            <input type="text" id="my-symbol" maxlength="4" placeholder="ABCD" style="font-size:32px;">
        </div>
        <div id="lacivert-bolge" class="bolge">
            <h3>‚òÄÔ∏è: <span id="gv">60</span>s | üåô: <span id="nv">30</span>s</h3>
            <input type="range" id="gs" min="10" max="180" value="60" oninput="gv.innerText=this.value" style="width:100%"><br>
            <input type="range" id="ns" min="10" max="180" value="30" oninput="nv.innerText=this.value" style="width:100%">
        </div>
        <div id="acik-mavi-bolge" class="bolge">
            <h2 id="my-code" style="color:var(--mavi); font-size: 28px;">KOD: ------</h2>
            <button onclick="startGame()" style="background:var(--yesil); color: black;">BA≈ûLAT</button>
        </div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="info-bar">BEKLENƒ∞YOR...</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
    </div>

    <script>
        let peer; let conn; let myId; let isHost = false;
        let players = {}; let myNick = ""; let mySymbol = "";
        let gameActive = false; let isNight = false;

        // --- ONLINE BAƒûLANTI Sƒ∞STEMƒ∞ (PEERJS) ---
        function hostLobby() {
            myNick = document.getElementById('my-name').value;
            if(!myNick) return alert("ƒ∞sim gir!");
            isHost = true;
            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-code').innerText = "KOD: " + id;
                showLobby();
            });
            peer.on('connection', (c) => {
                conn = c; setupConn();
            });
        }

        function joinLobby() {
            myNick = document.getElementById('my-name').value;
            const code = prompt("6 Haneli Lobi Kodunu Yaz:");
            if(!code || !myNick) return;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                setupConn();
                showLobby();
            });
        }

        function setupConn() {
            conn.on('data', (data) => {
                if(data.type === 'move') updateRemotePlayer(data);
                if(data.type === 'start') realStart();
                if(data.type === 'nightAction') moveRemoteToCadir(data);
            });
        }

        // --- LOBƒ∞ MANTIƒûI ---
        function showLobby() {
            document.getElementById('ana-menu').style.display = 'none';
            document.getElementById('lobi-ekrani').style.display = 'grid';
            const rDiv = document.getElementById('roles');
            const rList = ["≈ûifacƒ±", "Bek√ßi", "ƒ∞zci", "Bilge", "Diren√ßli", "Avcƒ±", "ƒ∞spiyoncu", "Katil 1", "Katil 2", "K√∂t√º Polis", "K√∂t√º G√∂zc√º", "Meczup"];
            rList.forEach(r => { rDiv.innerHTML += `<div class="rol-text"><input type="checkbox" checked style="width:25px;height:25px;"> ${r}</div>`; });
            
            // Kendi karakterini ekle
            addPlayerToLobby('me', myNick);
        }

        function addPlayerToLobby(id, name) {
            const area = document.getElementById('player-area');
            area.innerHTML += `<div id="p-${id}" class="p-body" style="left:50px; top:50px;"><span class="p-label">${name}</span></div>`;
        }

        function sendMove(e) {
            const rect = document.getElementById('gri-bolge').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 22;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 22;
            const me = document.getElementById('p-me');
            me.style.left = x + "px"; me.style.top = y + "px";
            if(conn) conn.send({type: 'move', x: x, y: y, name: myNick});
        }

        function updateRemotePlayer(data) {
            let p = document.getElementById('p-remote');
            if(!p) { addPlayerToLobby('remote', data.name); p = document.getElementById('p-remote'); }
            p.style.left = data.x + "px"; p.style.top = data.y + "px";
        }

        // --- OYUN MANTIƒûI ---
        function startGame() {
            if(conn) conn.send({type: 'start'});
            realStart();
        }

        function realStart() {
            gameActive = true;
            mySymbol = document.getElementById('my-symbol').value || "USER";
            document.getElementById('lobi-ekrani').style.display = 'none';
            document.getElementById('oyun-ekrani').style.display = 'block';
            
            const oba = document.getElementById('oba');
            const mX = window.innerWidth / 2; const mY = window.innerHeight / 2;
            const r = Math.min(window.innerWidth, window.innerHeight) * 0.35;

            for(let i=0; i<12; i++) {
                const aci = (i * 2 * Math.PI) / 12;
                const x = mX + r * Math.cos(aci) - 50;
                const y = mY + r * Math.sin(aci) - 50;
                oba.innerHTML += `
                    <div class="cadir" style="left:${x}px; top:${y}px" onclick="useAbility(${i})">
                        <div style="font-size:55px">‚õ∫</div>
                        <div class="oyuncu-govde" id="oba-p-${i}">
                            <div class="nick-tag">${i === 0 ? mySymbol : 'P'+(i+1)}</div>
                        </div>
                    </div>`;
            }
            gameLoop();
        }

        // --- SADECE GECE HAREKET (3.3 SANƒ∞YE) ---
        function useAbility(id) {
            if(!isNight) return; // G√ºnd√ºz tƒ±klanan yere gitme engellendi!
            
            const p = document.getElementById('oba-p-0');
            const hedef = document.querySelectorAll('.cadir')[id].getBoundingClientRect();
            const suan = p.getBoundingClientRect();

            p.style.position = "fixed";
            p.style.left = suan.left + "px"; p.style.top = suan.top + "px";
            
            setTimeout(() => {
                p.style.left = (hedef.left + 28) + "px";
                p.style.top = (hedef.top + 28) + "px";
            }, 50);

            if(conn) conn.send({type: 'nightAction', targetId: id});

            setTimeout(() => {
                p.style.position = "relative"; p.style.left = "0"; p.style.top = "0";
            }, 3350);
        }

        function gameLoop() {
            let sn = parseInt(document.getElementById('gs').value);
            let mod = "G√úND√úZ";
            setInterval(() => {
                sn--;
                if(sn <= 0) {
                    mod = (mod === "G√úND√úZ") ? "GECE" : "G√úND√úZ";
                    isNight = (mod === "GECE");
                    sn = isNight ? parseInt(document.getElementById('ns').value) : parseInt(document.getElementById('gs').value);
                    document.getElementById('oyun-ekrani').className = isNight ? "ekran gece" : "ekran";
                }
                const ikon = isNight ? "üåô" : "‚òÄÔ∏è";
                document.getElementById('info-bar').innerText = ikon + " " + mod + ": " + sn + "s";
            }, 1000);
        }
    </script>
</body>
</html>
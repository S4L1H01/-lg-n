<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN: KABƒ∞LE MECLƒ∞Sƒ∞</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mor: #8b5cf6; --kirmizi: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #020617; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: #0a0a0a; }
        .menu-box { width: 90%; max-width: 400px; padding: 25px; border: 5px solid; text-align: center; border-radius: 20px; font-weight: 900; font-size: 22px; cursor: pointer; }
        .box-isim { border-color: var(--mor); cursor: default; }
        input { background: transparent; border: none; border-bottom: 3px solid var(--mor); color: white; text-align: center; font-size: 22px; width: 100%; outline: none; }

        /* LOBƒ∞ */
        #lobi-ekrani { grid-template-columns: 1fr 1fr; grid-template-rows: 1.5fr 1fr 0.6fr; gap: 10px; padding: 15px; background: #0f172a; }
        .bolge { border: 2px solid #334155; border-radius: 15px; position: relative; padding: 15px; background: rgba(30, 41, 59, 0.5); }
        #player-area { height: 100%; position: relative; background: #1e293b; border-radius: 10px; border: 2px dashed #475569; }
        
        .p-body { position: absolute; width: 45px; height: 45px; background: #fff; border-radius: 50%; border: 3px solid #000; transition: 0.3s; }
        .p-label { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 2px 8px; border-radius: 5px; font-size: 12px; white-space: nowrap; border: 1px solid #fff; }

        /* KOPYALAMA BUTONU */
        #my-code { cursor: pointer; background: rgba(59, 130, 246, 0.2); padding: 10px; border-radius: 10px; border: 1px solid var(--mavi); transition: 0.3s; }
        #my-code:hover { background: var(--mavi); color: white; }

        /* OYUN */
        #oyun-ekrani { background: #1e4d2b; transition: 1s; }
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; z-index: 10; filter: drop-shadow(0 0 20px orange); }
        .cadir { position: absolute; width: 90px; text-align: center; z-index: 5; }
        .oyuncu-govde { width: 45px; height: 45px; background: #94a3b8; border-radius: 50%; margin: 0 auto; position: relative; border: 3px solid #000; transition: all 3.3s linear; }

        /* GECE */
        .gece-modu { background: #0c1445 !important; }
        #ay { display: none; position: absolute; top: 50px; left: 50px; font-size: 50px; filter: drop-shadow(0 0 10px white); }
        .gece-modu #ay { display: block; }
        
        #rol-tabelasi { position: fixed; top: 20px; right: 20px; background: var(--altin); color: #000; padding: 10px 20px; border-radius: 12px; font-weight: 900; z-index: 1001; border: 3px solid #000; }
        #info-bar { position: fixed; top: 20px; width: 100%; text-align: center; font-size: 28px; font-weight: 900; color: #fff; z-index: 100; text-shadow: 2px 2px #000; }

        #not-defteri { position: fixed; bottom: 20px; right: 20px; width: 220px; height: 200px; background: #fef3c7; color: #451a03; border-radius: 10px; padding: 10px; z-index: 1000; border: 2px solid #d97706; }
        #not-text { width: 100%; height: 80%; background: transparent; border: none; resize: none; outline: none; font-size: 13px; font-weight: bold; }
        
        .btn { padding: 15px 30px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; background: var(--yesil); color: black; }
    </style>
</head>
<body>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <h1 style="color:var(--altin); font-size: 50px;">√úLG√úN</h1>
        <div class="menu-box box-isim"><input type="text" id="my-name" placeholder="ƒ∞SMƒ∞Nƒ∞Z"></div>
        <div class="menu-box" style="border-color:var(--kirmizi)" onclick="joinLobby()">KOD ƒ∞LE KATIL</div>
        <div class="menu-box" style="border-color:var(--mavi)" onclick="hostLobby()">LOBƒ∞ KUR</div>
    </div>

    <div id="lobi-ekrani" class="ekran">
        <div class="bolge" style="grid-column: span 1;" onclick="sendMove(event)">
            <div id="player-area"></div>
        </div>
        <div class="bolge" id="yesil-bolge">
            <h2 style="color:var(--yesil)">ROLLER</h2>
            <div id="roles-list"></div>
        </div>
        <div class="bolge" style="grid-column: span 2; display: flex; justify-content: space-between; align-items: center;">
            <div id="my-code" onclick="copyCode()">KOD: BEKLENƒ∞YOR...</div>
            <div id="status">Oyuncular bekleniyor...</div>
            <button class="btn" onclick="startGame()">OYUNU BA≈ûLAT</button>
        </div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="ay">üåô</div>
        <div id="rol-tabelasi">ROL: ≈ûifacƒ±</div>
        <div id="info-bar">‚òÄÔ∏è G√úND√úZ</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
        <div id="not-defteri"><b>üìî G√úNL√úK</b><textarea id="not-text"></textarea></div>
    </div>

    <script>
        let peer; let conn; let myNick = ""; let connections = [];
        let lobbyPlayers = []; let tur = 1;

        // --- ONLINE Sƒ∞STEMƒ∞ ---
        function hostLobby() {
            myNick = document.getElementById('my-name').value;
            if(!myNick) return alert("ƒ∞sim gir!");
            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', id => {
                document.getElementById('my-code').innerText = "KOD: " + id + " (Tƒ±kla Kopyala)";
                addPlayer(id, myNick, true);
                initLobbyView();
            });
            peer.on('connection', c => {
                c.on('data', data => {
                    if(data.type === 'join') {
                        addPlayer(c.peer, data.name, false);
                        broadcast({type: 'updateList', list: lobbyPlayers});
                    }
                    if(data.type === 'move') updatePlayerPos(c.peer, data.x, data.y);
                });
                connections.push(c);
            });
        }

        function joinLobby() {
            myNick = document.getElementById('my-name').value;
            const code = prompt("Lobi Kodu:");
            if(!code || !myNick) return;
            peer = new Peer();
            peer.on('open', () => {
                const c = peer.connect(code);
                c.on('open', () => {
                    c.send({type: 'join', name: myNick});
                    initLobbyView();
                    document.getElementById('my-code').innerText = "KOD: " + code;
                });
                c.on('data', data => {
                    if(data.type === 'updateList') syncLobby(data.list);
                    if(data.type === 'start') realStart(data.count);
                });
                connections.push(c);
            });
        }

        function copyCode() {
            const code = document.getElementById('my-code').innerText.split(' ')[1];
            navigator.clipboard.writeText(code);
            alert("Kod kopyalandƒ±: " + code);
        }

        // --- LOBƒ∞ Y√ñNETƒ∞Mƒ∞ ---
        function addPlayer(id, name, isMe) {
            lobbyPlayers.push({id, name, x: 50, y: 50});
            syncLobby(lobbyPlayers);
        }

        function syncLobby(list) {
            lobbyPlayers = list;
            const area = document.getElementById('player-area');
            area.innerHTML = "";
            list.forEach(p => {
                area.innerHTML += `<div id="p-${p.id}" class="p-body" style="left:${p.x}px; top:${p.y}px"><span class="p-label">${p.name}</span></div>`;
            });
            document.getElementById('status').innerText = list.length + " Oyuncu Hazƒ±r";
        }

        function initLobbyView() {
            document.getElementById('ana-menu').style.display = 'none';
            document.getElementById('lobi-ekrani').style.display = 'grid';
            const rList = ["≈ûifacƒ±", "Katil", "Bek√ßi", "G√∂zc√º", "Bilge", "Meczup"];
            rList.forEach(r => { document.getElementById('roles-list').innerHTML += `<b>‚óà ${r}</b><br>`; });
        }

        function sendMove(e) {
            const rect = document.getElementById('player-area').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 22;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 22;
            const myP = document.getElementById(`p-${peer.id}`);
            if(myP) { myP.style.left = x + "px"; myP.style.top = y + "px"; }
            connections.forEach(c => c.send({type: 'move', x: x, y: y}));
        }

        function updatePlayerPos(id, x, y) {
            const p = document.getElementById(`p-${id}`);
            if(p) { p.style.left = x + "px"; p.style.top = y + "px"; }
        }

        function broadcast(data) {
            connections.forEach(c => c.send(data));
        }

        // --- OYUN BA≈ûLATMA ---
        function startGame() {
            let finalCount = lobbyPlayers.length;
            if(finalCount < 2) { // Test i√ßin bot ekle
                finalCount = 4;
            }
            broadcast({type: 'start', count: finalCount});
            realStart(finalCount);
        }

        function realStart(count) {
            document.getElementById('lobi-ekrani').style.display = 'none';
            document.getElementById('oyun-ekrani').style.display = 'block';
            const oba = document.getElementById('oba');
            const mX = window.innerWidth / 2; const mY = window.innerHeight / 2;
            const r = Math.min(window.innerWidth, window.innerHeight) * 0.35;

            oba.innerHTML = "";
            for(let i=0; i<count; i++) {
                const aci = (i * 2 * Math.PI) / count;
                const x = mX + r * Math.cos(aci) - 45;
                const y = mY + r * Math.sin(aci) - 45;
                oba.innerHTML += `
                    <div class="cadir" style="left:${x}px; top:${y}px" onclick="rolGit(${i})">
                        <div style="font-size:50px">‚õ∫</div>
                        <div class="oyuncu-govde" id="oba-p-${i}">
                            <div style="position:absolute; bottom:-25px; left:50%; transform:translateX(-50%); font-size:12px; font-weight:bold; white-space:nowrap;">
                                ${lobbyPlayers[i] ? lobbyPlayers[i].name : 'Bot '+(i+1)}
                            </div>
                        </div>
                    </div>`;
            }
            gameLoop();
        }

        function rolGit(id) {
            if(!document.getElementById('oyun-ekrani').classList.contains('gece-modu')) return;
            const p = document.getElementById('oba-p-0');
            const hedef = document.querySelectorAll('.cadir')[id].getBoundingClientRect();
            const suan = p.getBoundingClientRect();
            p.style.position = "fixed";
            p.style.left = suan.left + "px"; p.style.top = suan.top + "px";
            setTimeout(() => {
                p.style.left = (hedef.left + 22) + "px"; p.style.top = (hedef.top + 22) + "px";
            }, 50);
            document.getElementById('not-text').value += `${tur}. Gece: ${id+1}. eve gidildi.\n`;
            setTimeout(() => {
                p.style.position = "relative"; p.style.left = "0"; p.style.top = "0";
            }, 3350);
        }

        function gameLoop() {
            let sn = 60; // Ba≈ülangƒ±√ß g√ºnd√ºz s√ºresi
            let mod = "G√úND√úZ";
            setInterval(() => {
                sn--;
                if(sn <= 0) {
                    if(mod === "GECE") tur++;
                    mod = (mod === "G√úND√úZ") ? "GECE" : "G√úND√úZ";
                    sn = (mod === "G√úND√úZ") ? 60 : 30;
                    document.getElementById('oyun-ekrani').classList.toggle('gece-modu');
                }
                document.getElementById('info-bar').innerText = (mod === "G√úND√úZ" ? "‚òÄÔ∏è " : "üåô ") + mod + ": " + sn + "s";
            }, 1000);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úLG√úN: KABƒ∞LE v3.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mor: #a855f7; --kirmizi: #ef4444; --mavi: #3b82f6; --yesil: #22c55e; --altin: #fbbf24; --arkaplan: #020617; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--arkaplan); color: white; overflow: hidden; }

        .ekran { display: none; height: 100vh; width: 100vw; position: absolute; }
        #ana-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: radial-gradient(circle, #1e1b4b, #020617); }
        .menu-box { width: 90%; max-width: 400px; padding: 25px; border: 4px solid; text-align: center; border-radius: 20px; font-weight: 900; font-size: 22px; cursor: pointer; transition: 0.3s; }
        .box-isim { border-color: var(--mor); cursor: default; }
        input { background: transparent; border: none; border-bottom: 3px solid var(--mor); color: white; text-align: center; font-size: 22px; width: 100%; outline: none; }

        /* LOBƒ∞ */
        #lobi-ekrani { grid-template-columns: 1fr 1fr; grid-template-rows: 1.5fr 1fr 0.6fr; gap: 12px; padding: 15px; background: #0f172a; }
        .bolge { border: 2px solid #334155; border-radius: 15px; position: relative; padding: 15px; background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(5px); }
        #player-area { height: 100%; position: relative; background: #1e293b; border-radius: 10px; border: 2px dashed #475569; overflow: hidden; }
        .p-body { position: absolute; width: 45px; height: 45px; background: #fff; border-radius: 50%; border: 3px solid #000; transition: 0.2s linear; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .p-label { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 2px 8px; border-radius: 5px; font-size: 11px; white-space: nowrap; border: 1px solid #fff; }

        /* OYUN */
        #oyun-ekrani { background: #14532d; transition: background 2s; }
        #ates { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 70px; z-index: 10; filter: drop-shadow(0 0 30px orange); animation: fire 0.2s infinite alternate; }
        @keyframes fire { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.1); } }
        .cadir { position: absolute; width: 95px; text-align: center; z-index: 5; }
        .oyuncu-govde { width: 45px; height: 45px; background: #64748b; border-radius: 50%; margin: 0 auto; position: relative; border: 3px solid #000; transition: all 3.3s linear; }

        /* GECE MODU */
        .gece-modu { background: #080c29 !important; }
        #ay { display: none; position: absolute; top: 40px; right: 40px; font-size: 55px; filter: drop-shadow(0 0 15px #fff); }
        .gece-modu #ay { display: block; animation: float 4s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        #rol-tabelasi { position: fixed; top: 20px; right: 20px; background: var(--altin); color: #000; padding: 12px 20px; border-radius: 12px; font-weight: 900; z-index: 1001; border: 3px solid #000; box-shadow: 4px 4px 0 #000; }
        #info-bar { position: fixed; top: 20px; width: 100%; text-align: center; font-size: 30px; font-weight: 900; color: #fff; z-index: 100; text-shadow: 3px 3px #000; }
        #not-defteri { position: fixed; bottom: 20px; right: 20px; width: 230px; height: 220px; background: #fef3c7; color: #451a03; border-radius: 12px; padding: 12px; z-index: 1000; border: 3px solid #d97706; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); }
        #not-text { width: 100%; height: 85%; background: transparent; border: none; resize: none; outline: none; font-size: 14px; font-weight: bold; }

        .btn { padding: 15px 30px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .copy-info { font-size: 10px; color: var(--mavi); display: block; }
    </style>
</head>
<body>

    <div id="ana-menu" class="ekran" style="display: flex;">
        <h1 style="color:var(--altin); font-size: 60px; text-shadow: 4px 4px var(--mor);">√úLG√úN</h1>
        <div class="menu-box box-isim"><input type="text" id="my-name" placeholder="ADINIZ"></div>
        <div class="menu-box" style="border-color:var(--kirmizi)" onclick="joinLobby()">KOD ƒ∞LE KATIL</div>
        <div class="menu-box" style="border-color:var(--mavi)" onclick="hostLobby()">LOBƒ∞ KUR</div>
    </div>

    <div id="lobi-ekrani" class="ekran">
        <div class="bolge" style="grid-column: span 1;" onclick="sendMove(event)">
            <div id="player-area"></div>
        </div>
        <div class="bolge" id="roles-bolge">
            <h2 style="color:var(--yesil); margin:0;">üìú ROLLER (14)</h2>
            <div id="roles-list" style="font-size: 12px; columns: 2; margin-top: 5px;"></div>
        </div>
        <div class="bolge" id="settings-bolge">
            <h3>AYARLAR</h3>
            ‚òÄÔ∏è G√ºnd√ºz: <span id="gv">60</span>s <input type="range" id="gs" min="10" max="120" value="60" oninput="gv.innerText=this.value" style="width:100%"><br>
            üåô Gece: <span id="nv">30</span>s <input type="range" id="ns" min="10" max="120" value="30" oninput="nv.innerText=this.value" style="width:100%">
        </div>
        <div class="bolge" style="grid-column: span 2; display: flex; justify-content: space-between; align-items: center;">
            <div id="my-code" onclick="copyCode()" style="cursor:pointer; font-weight:bold; color:var(--mavi)">KOD: BEKLENƒ∞YOR...<span class="copy-info">(Tƒ±kla Kopyala)</span></div>
            <div id="status" style="font-weight:bold; color:var(--altin);">Baƒülanƒ±yor...</div>
            <button class="btn" onclick="startGame()" style="background:var(--yesil); color: black;">MECLƒ∞Sƒ∞ BA≈ûLAT</button>
        </div>
    </div>

    <div id="oyun-ekrani" class="ekran">
        <div id="ay">üåô</div>
        <div id="rol-tabelasi">ROL√úN: ≈ûifacƒ±</div>
        <div id="info-bar">‚òÄÔ∏è G√úND√úZ</div>
        <div id="ates">üî•</div>
        <div id="oba"></div>
        <div id="not-defteri"><b>üìî KABƒ∞LE G√úNL√úƒû√ú</b><textarea id="not-text"></textarea></div>
    </div>

    <script>
        let peer; let conn; let myNick = ""; let connections = [];
        let players = []; let tur = 1; let isHost = false;
        const allRoles = ["≈ûifacƒ±", "Katil", "Bek√ßi", "G√∂zc√º", "Bilge", "Meczup", "Avcƒ±", "ƒ∞zci", "Diren√ßli", "ƒ∞spiyoncu", "G√∂lge", "K√∂t√º Polis", "Kaos", "Gardiyan"];

        function hostLobby() {
            myNick = document.getElementById('my-name').value;
            if(!myNick) return alert("ƒ∞sim yaz!");
            isHost = true;
            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', id => {
                document.getElementById('my-code').innerHTML = `KOD: ${id} <span class="copy-info">(Tƒ±kla Kopyala)</span>`;
                players.push({id: id, name: myNick, x: 50, y: 50});
                updateLobby();
                document.getElementById('status').innerText = "Lobi Kuruldu";
            });
            peer.on('connection', c => {
                c.on('open', () => {
                    connections.push(c);
                    c.on('data', data => handleData(data, c));
                });
            });
            initLobbyUI();
        }

        function joinLobby() {
            myNick = document.getElementById('my-name').value;
            const code = prompt("Lobi Kodunu Girin:");
            if(!code || !myNick) return;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                conn.on('open', () => {
                    conn.send({type: 'join', name: myNick});
                    initLobbyUI();
                    document.getElementById('my-code').innerText = "KOD: " + code;
                });
                conn.on('data', data => handleData(data));
            });
        }

        function handleData(data, c) {
            if(data.type === 'join' && isHost) {
                players.push({id: c.peer, name: data.name, x: 50, y: 50});
                broadcast({type: 'sync', players: players});
            }
            if(data.type === 'sync') { players = data.players; updateLobby(); }
            if(data.type === 'move') { updateRemotePos(data.id, data.x, data.y); }
            if(data.type === 'start') { setupGame(data.roles, data.gS, data.nS); }
        }

        function initLobbyUI() {
            document.getElementById('ana-menu').style.display = 'none';
            document.getElementById('lobi-ekrani').style.display = 'grid';
            const list = document.getElementById('roles-list');
            allRoles.forEach(r => list.innerHTML += `‚Ä¢ ${r}<br>`);
        }

        function copyCode() {
            const code = document.getElementById('my-code').innerText.split(' ')[1];
            navigator.clipboard.writeText(code).then(() => alert("Kod Kopyalandƒ±!"));
        }

        function sendMove(e) {
            const rect = document.getElementById('player-area').getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left - 22;
            const y = (e.clientY || e.touches[0].clientY) - rect.top - 22;
            const myP = document.getElementById(`p-${peer.id}`);
            if(myP) { myP.style.left = x + "px"; myP.style.top = y + "px"; }
            if(isHost) broadcast({type: 'move', id: peer.id, x, y});
            else if(conn) conn.send({type: 'move', id: peer.id, x, y});
        }

        function updateLobby() {
            const area = document.getElementById('player-area');
            area.innerHTML = "";
            players.forEach(p => {
                area.innerHTML += `<div id="p-${p.id}" class="p-body" style="left:${p.x}px; top:${p.y}px"><span class="p-label">${p.name}</span></div>`;
            });
            document.getElementById('status').innerText = players.length + " Oyuncu";
        }

        function updateRemotePos(id, x, y) {
            const p = document.getElementById(`p-${id}`);
            if(p) { p.style.left = x + "px"; p.style.top = y + "px"; }
        }

        function broadcast(data) {
            connections.forEach(c => c.send(data));
        }

        // --- OYUN MANTIƒûI ---
        function startGame() {
            if(!isHost) return alert("Sadece lobi kurucusu ba≈ülatabilir!");
            // Rolleri karƒ±≈ütƒ±r ve daƒüƒ±t
            let shuffledRoles = [...allRoles].sort(() => Math.random() - 0.5);
            const gS = document.getElementById('gs').value;
            const nS = document.getElementById('ns').value;
            const startData = {type: 'start', roles: shuffledRoles, gS, nS};
            broadcast(startData);
            setupGame(shuffledRoles, gS, nS);
        }

        function setupGame(roles, gS, nS) {
            const myIndex = players.findIndex(p => p.id === peer.id);
            document.getElementById('rol-tabelasi').innerText = "ROL√úN: " + roles[myIndex];
            document.getElementById('lobi-ekrani').style.display = 'none';
            document.getElementById('oyun-ekrani').style.display = 'block';

            const oba = document.getElementById('oba');
            const mX = window.innerWidth / 2; const mY = window.innerHeight / 2;
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.35;
            
            // Toplam 12 ki≈üi (oyuncular + botlar)
            oba.innerHTML = "";
            for(let i=0; i<12; i++) {
                const aci = (i * 2 * Math.PI) / 12;
                const x = mX + radius * Math.cos(aci) - 45;
                const y = mY + radius * Math.sin(aci) - 45;
                const pName = players[i] ? players[i].name : "Kabile √úyesi " + (i+1);
                
                oba.innerHTML += `
                    <div class="cadir" style="left:${x}px; top:${y}px" onclick="action(${i})">
                        <div style="font-size:50px">‚õ∫</div>
                        <div class="oyuncu-govde" id="oba-p-${i}">
                            <div style="position:absolute; bottom:-25px; left:50%; transform:translateX(-50%); font-size:12px; font-weight:bold; white-space:nowrap;">${pName}</div>
                        </div>
                    </div>`;
            }
            runGameLoop(parseInt(gS), parseInt(nS));
        }

        function action(id) {
            if(!document.getElementById('oyun-ekrani').classList.contains('gece-modu')) return;
            const p = document.getElementById('oba-p-0');
            const target = document.querySelectorAll('.cadir')[id].getBoundingClientRect();
            const current = p.getBoundingClientRect();
            p.style.position = "fixed";
            p.style.left = current.left + "px"; p.style.top = current.top + "px";
            setTimeout(() => {
                p.style.left = (target.left + 25) + "px"; p.style.top = (target.top + 25) + "px";
            }, 50);
            document.getElementById('not-text').value += `${tur}. Gece: ${id+1}. eve i≈ülem yapƒ±ldƒ±.\n`;
            setTimeout(() => { p.style.position = "relative"; p.style.left = "0"; p.style.top = "0"; }, 3350);
        }

        function runGameLoop(gS, nS) {
            let sn = gS;
            let mod = "G√úND√úZ";
            setInterval(() => {
                sn--;
                if(sn <= 0) {
                    if(mod === "GECE") tur++;
                    mod = (mod === "G√úND√úZ") ? "GECE" : "G√úND√úZ";
                    sn = (mod === "G√úND√úZ") ? gS : nS;
                    document.getElementById('oyun-ekrani').classList.toggle('gece-modu');
                }
                const ikon = (mod === "G√úND√úZ" ? "‚òÄÔ∏è " : "üåô ");
                document.getElementById('info-bar').innerText = ikon + mod + ": " + sn + "s";
            }, 1000);
        }
    </script>
</body>
</html>